<html>
<script src="codemirror.min.js"></script>
<link href="codemirror.min.css" rel="stylesheet">
<script src="liquid.min.js"></script>
<link href="liquid.min.css" rel="stylesheet">
<style type="text/css">
	.CodeMirror { height: auto; border: 1px solid #ddd; }
	.CodeMirror-scroll {height: auto; overflow: hidden !important; }
	.CodeMirror pre { padding-left: 7px; line-height: 1.25; }
</style>
<script>
	var templates = [
		CodeMirror.Doc(decodeURIComponent('%7B%0A%20%20%20%20%22user%22%3A%22%D0%A0%D0%BE%D0%BC%D0%B0%D0%BD%22%2C%0A%20%20%20%20%22today%22%3A%2212-12-12%22%2C%0A%20%20%20%20%22users%22%3A%5B%0A%20%20%20%20%20%20%7B%20%22name%22%3A%22Matt%22%20%7D%2C%0A%20%20%20%20%20%20%7B%20%22name%22%3A%22Dan%22%20%7D%2C%0A%20%20%20%20%20%20%7B%20%22name%22%3A%22Sam%22%20%7D%0A%20%20%20%20%5D%0A%20%20%7D'), 'application/json'),
		CodeMirror.Doc(decodeURIComponent('%7B%7B%20user%20%7D%7D%20says%20hi!%0A%0A%7B%25%20for%20user%20in%20users%20%25%7D%0A%20%20*%20%7B%7B%20user.name%20%7D%7D%0A%7B%25%20endfor%20%25%7D%0A%0AMaybe%3A%20%7B%7B%20users.0.name%20%7D%7D%0A%0A%7B%25%20include%20\'2\'%20with%20user%20%25%7D%0A%0AThe%20end.'), 'liquid'),
		CodeMirror.Doc(decodeURIComponent('Hello!%20%7B%7B%20user%20%7D%7D%2C%20how%20are%20you%3F'), 'liquid')
	];

	function parseIt() {
		var json;
		try {
			json = JSON.parse(templates[0].getValue());
		} catch (ex) {
			json = null;
		}

		var src = templates[1].getValue();
		var tmpl = Liquid.parse(src);

		var html = tmpl.renderWithErrors(json);
		output_editor.setValue(html);
	}

	function selectBuffer(num) {
	  var buf = templates[num];
	  if (buf.getEditor()) buf = buf.linkedDoc({sharedHist: true});
	  var old = src_editor.swapDoc(buf);
	  var linked = old.iterLinkedDocs(function(doc) {linked = doc;});
	  if (linked) {
	    for (var num in templates) if (templates[num] == old) templates[num] = linked;
	    old.unlinkDoc(linked);
	  }
	  src_editor.focus();
	}

	Liquid.readTemplateFile = function(num) {
		if (templates[num] && templates[num].getValue) {
			return templates[num].getValue();
		} else {
			throw "Could not find template for " + num;
		}
	}
</script>

<body>
	<select multiple="multiple" id="templates_select" style="width:100%">
		<option value="0">0</option>
		<option value="1">1</option>
		<option value="2">2</option>
	</select>
	<div id="src"></div>
	<br/>
	<button onclick="parseIt()">Parse</button>
	<hr/>
	<div id="output"></div>
	<script type="text/javascript">
		CodeMirror.on(document.getElementById('templates_select'), "change", function() {
			var sel = document.getElementById('templates_select');
			selectBuffer(sel.options[sel.selectedIndex].value);
		});

		var src_editor = CodeMirror(document.getElementById("src"), {
			mode: "liquid",
			lineNumbers: true,
			matchBrackets: true
		});

		var output_editor = CodeMirror(document.getElementById("output"), {
			lineNumbers: true,
			matchBrackets: true
		});
	</script>
</body>
</html>
